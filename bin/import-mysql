#!/usr/bin/env ruby 

require 'rubygems'
require 'mysql'
require 'time'

begin
  # connect to the MySQL server
  dbh = Mysql.real_connect("localhost", "sensors", "test", "sensors")
  # get server version string and display it
  puts "Server version: " + dbh.get_server_info
  
  nrows = 0
  while not $stdin.eof?
    values = $stdin.readline.split("|").map{|s| s.strip}
    if values[2] != ""
      dbh.query("INSERT into sensor_reads (sensor, date, value) VALUES
                   (\"#{values[0]}\", #{values[1]}, #{values[2]})")
      nrows += dbh.affected_rows
    end
  end
  puts "Number of rows inserted: #{nrows}"
rescue Mysql::Error => e
  puts "Error code: #{e.errno}"
  puts "Error message: #{e.error}"
  puts "Error SQLSTATE: #{e.sqlstate}" if e.respond_to?("sqlstate")
ensure
  # disconnect from server
  dbh.close if dbh
end

