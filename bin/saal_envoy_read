#!/usr/bin/env ruby

require File.dirname(__FILE__)+'/../lib/saal.rb'

if ARGV.size != 3
  $stderr.puts "USAGE: saal_envoy_read <host> <user> <password>"
  exit(1)
end

def fdisp(val)
  if val
    '%10.0f' % val
  else
    "n/a"
  end
end

def fdispk(val)
  if val
    '%10.2f' % (val / 1000.0)
  else
    "n/a"
  end
end

def fdisp_dec(val)
  if val
    '%10.2f' % val
  else
    "n/a"
  end
end

ac_quality = SAAL::Envoy::ACQuality::new(:host => ARGV[0]).create_sensors

puts " ========= AC QUALITY ========"
puts "        voltage (V)  freq (Hz)"
def qual_line(vals,name, type)
  puts " #{name} \
#{fdisp_dec(vals["#{type}_voltage"].read)} \
#{fdisp_dec(vals["#{type}_frequency"].read)} \
"
end
qual_line(ac_quality, "Total: ", "total")
qual_line(ac_quality, "Phase1:", "phase1")
qual_line(ac_quality, "Phase2:", "phase2")
qual_line(ac_quality, "Phase3:", "phase3")

production = SAAL::Envoy::PowerEnergy::new(:host => ARGV[0]).create_sensors

puts ""
puts " ============ TRUE POWER (W) ============"
puts "        consumption production        net"
def p_line(vals, name, type, metric)
  puts " #{name} \
#{fdisp(vals["consumption_total#{type}_#{metric}"].read)} \
#{fdisp(vals["production#{type}_#{metric}"].read)} \
#{fdisp(vals["consumption_net#{type}_#{metric}"].read)} \
"
end
p_line(production, "Total: ", "", "w_now")
p_line(production, "Phase1:", "_phase1", "w_now")
p_line(production, "Phase2:", "_phase2", "w_now")
p_line(production, "Phase3:", "_phase3", "w_now")
puts " Total Inverters:   \
#{fdisp(production["production_inverters_w_now"].read)} \
"


puts ""
puts " ========== APPARENT POWER (VA) ========="
puts "        consumption production        net"
p_line(production, "Total: ", "", "va_now")
p_line(production, "Phase1:", "_phase1", "va_now")
p_line(production, "Phase2:", "_phase2", "va_now")
p_line(production, "Phase3:", "_phase3", "va_now")

puts ""
puts " ========== TRUE ENERGY (kWh) ==========="
puts "        consumption production        net"
def e_line(vals, name, type, metric)
  puts " #{name} \
#{fdispk(vals["consumption_total#{type}_#{metric}"].read)} \
#{fdispk(vals["production#{type}_#{metric}"].read)} \
#{fdispk(vals["consumption_net#{type}_#{metric}"].read)} \
"
end
e_line(production, "Total: ", "", "wh_lifetime")
e_line(production, "Phase1:", "_phase1", "wh_lifetime")
e_line(production, "Phase2:", "_phase2", "wh_lifetime")
e_line(production, "Phase3:", "_phase3", "wh_lifetime")
puts " Total Inverters:              \
#{fdispk(production["production_inverters_wh_lifetime"].read)} \
"

puts ""
puts " ======== APPARENT ENERGY (kVAh) ========"
puts "        consumption production        net"
e_line(production, "Total: ", "", "vah_lifetime")
e_line(production, "Phase1:", "_phase1", "vah_lifetime")
e_line(production, "Phase2:", "_phase2", "vah_lifetime")
e_line(production, "Phase3:", "_phase3", "vah_lifetime")


puts ""
envoy = SAAL::Envoy::Inverters::new(
  :host => ARGV[0],
  :user => ARGV[1],
  :password => ARGV[2],
)
envoy.set_all_inverters!
inverters = envoy.create_sensors
puts "Found #{envoy.inverters.size} inverters"
envoy.inverters.each do |serial|
  puts "INVERTER: #{serial} \
date:#{inverters["inverter_#{serial}_last_report_date"].read} \
lastWatts:#{inverters["inverter_#{serial}_w_now"].read} \
maxWatts:#{inverters["inverter_#{serial}_w_max"].read} \
"
end
