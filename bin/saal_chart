#!/usr/bin/env ruby
NUM_VALUES = 500 # Number of datapoints per series in the chart

require File.dirname(__FILE__)+'/../lib/saal.rb'

def usage
  $stderr.puts("Usage: saal_chart <chart dir>")
end

if ARGV.size != 1
  usage
  exit (2)
end

SENSOR_RANGES = {:temperature=>[-15, 45], :humidity=>[0,100], :pressure=>[950,1050]}


SAAL::Charts.new.each do |chart|
  $stderr.puts "Generating chart #{chart.name}"

  pngfile = ARGV[0]+'/chart-'+chart.name.to_s+'.png'
  ymlfile = ARGV[0]+'/chart-'+chart.name.to_s+'.yml'

  @mins = chart.minimum
  @maxs = chart.maximum
  @avgs = chart.average
  @minmax = {}
  chart.sensors.each do |s|
    s = s.name.to_sym
    @minmax[s] = {:maximum => @maxs[s], :minimum => @mins[s], :average => @avgs[s]}
  end

  File.open(ymlfile, 'w').write(YAML::dump(@minmax))

  def normalize_data(data, min, max)
    data.map do |i|
      if i.nil?
        -1.0
      elsif i < min
        0.0
      elsif i > max
        100.0
      else
        (((i-min)/(max-min).to_f)*1000).round/10.0
      end
    end
  end

  @periodnames = chart.periodnames
  @numperiods = @periodnames.size
  @averages = chart.average(NUM_VALUES)

  @data = chart.sensors.map do |sensor|
    normalize_data(@averages[sensor.name.to_sym], *(SENSOR_RANGES[sensor.sensor_type]))
  end

  @dataurl = @data.map {|values| values.join(",")}.join('|')

  r = {}
  case chart.alignlabels
  when :center
    @periodnamesurl = "||"+@periodnames.join('||')+"||"
  when :left
    @periodnamesurl = "|"+@periodnames.join('|')+"||"
    r[:chxs] = "0,555555,11,-1,lt"
  end
  @xincr = 100.0/@numperiods.to_f*10000.truncate.to_f/10000

  r[:chof] = "png"
  r[:chs] = "700x300"
  r[:cht] = "lc"
  r[:chco] = "00ff00,ff0000,0000ff,ffff00"
  r[:chxt] = "x,y,y,r"
  r[:chxl] = "0:#{@periodnamesurl}1:|-15ºC||0||15||30||45ºC|2:|0%|25|50|75|100%|3:|950||975||1000||1025||1050 hPa"
  r[:chg] = "#{@xincr},12.5,1,5"
  r[:chd] = "t:#{@dataurl}"

  @url = "http://chart.apis.google.com/chart?&"
  @postdata = r.map{|k,v| k.to_s+"="+v}.join("&")


  system "wget --quiet \"#{@url}\" --post-data=\"#{@postdata}\" -O #{pngfile}"
end
